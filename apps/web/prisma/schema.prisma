// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = []
}

datasource db {
  provider = "postgresql"
  // NOTE: When using mysql or sqlserver, uncomment the @db.Text annotations in model Account below
  // Further reading:
  // https://next-auth.js.org/adapters/prisma#create-the-prisma-schema
  // https://www.prisma.io/docs/reference/api-reference/prisma-schema-reference#string
  url      = env("DATABASE_URL")
}

model AppSetting {
  key   String @id
  value String
}

model SesSetting {
  id                   String   @id @default(cuid())
  region               String   @unique
  idPrefix             String   @unique
  topic                String
  topicArn             String?
  transactionalQuota   Int      @default(50)
  callbackUrl          String
  callbackSuccess      Boolean  @default(false)
  configGeneral        String?
  configGeneralSuccess Boolean  @default(false)
  configClick          String?
  configClickSuccess   Boolean  @default(false)
  configOpen           String?
  configOpenSuccess    Boolean  @default(false)
  configFull           String?
  configFullSuccess    Boolean  @default(false)
  sesEmailRateLimit    Int      @default(1)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}

// Necessary for Next auth
model Account {
  id                       String  @id @default(cuid())
  userId                   Int
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String? // @db.Text
  access_token             String? // @db.Text
  refresh_token_expires_in Int?
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String? // @db.Text
  session_state            String?
  user                     User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       Int
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model User {
  id            Int        @id @default(autoincrement())
  name          String?
  email         String?    @unique
  emailVerified DateTime?
  image         String?
  isBetaUser    Boolean    @default(false)
  isWaitlisted  Boolean    @default(false)
  createdAt     DateTime   @default(now())
  accounts      Account[]
  sessions      Session[]
  teamUsers     TeamUser[]
  auditLogs     AuditLog[]
}

enum Plan {
  FREE
  BASIC
}

model Team {
  id               Int               @id @default(autoincrement())
  name             String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  plan             Plan              @default(FREE)
  stripeCustomerId String?           @unique
  isActive         Boolean           @default(true)
  apiRateLimit     Int               @default(2)
  billingEmail     String?
  sesTenantId      String?
  isVerified       Boolean           @default(false)
  dailyEmailLimit  Int               @default(10000)
  isBlocked        Boolean           @default(false)
  teamUsers        TeamUser[]
  domains          Domain[]
  apiKeys          ApiKey[]
  emails           Email[]
  contactBooks     ContactBook[]
  campaigns        Campaign[]
  templates        Template[]
  dailyEmailUsages DailyEmailUsage[]
  subscription     Subscription[]
  invites          TeamInvite[]
  suppressionList  SuppressionList[]
  webhooks         Webhook[]
  scheduledReports ScheduledReport[]
  abTests          ABTest[]
  auditLogs        AuditLog[]
  sequences        AutomationSequence[]
  engagementPatterns ContactEngagementPattern[]
  sendTimeSettings   TeamSendTimeSettings?
  engagementEvents   EmailEngagementEvent[]
}

model TeamInvite {
  id        String   @id @default(cuid())
  teamId    Int
  email     String
  role      Role
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, email])
}

model Subscription {
  id                 String    @id
  teamId             Int
  status             String
  priceId            String
  priceIds           String[]
  currentPeriodEnd   DateTime?
  currentPeriodStart DateTime?
  cancelAtPeriodEnd  DateTime?
  paymentMethod      String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
}

enum Role {
  ADMIN
  MEMBER
}

model TeamUser {
  teamId Int
  userId Int
  role   Role
  team   Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
}

enum DomainStatus {
  NOT_STARTED
  PENDING
  SUCCESS
  FAILED
  TEMPORARY_FAILURE
}

model Domain {
  id            Int          @id @default(autoincrement())
  name          String       @unique
  teamId        Int
  status        DomainStatus @default(PENDING)
  region        String       @default("us-east-1")
  clickTracking Boolean      @default(false)
  openTracking  Boolean      @default(false)
  publicKey     String
  dkimSelector  String?      @default("usesend")
  dkimStatus    String?
  spfDetails    String?
  dmarcAdded    Boolean      @default(false)
  errorMessage  String?
  subdomain     String?
  sesTenantId   String?
  isVerifying   Boolean      @default(false)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  team          Team         @relation(fields: [teamId], references: [id], onDelete: Cascade)
  apiKeys       ApiKey[]
}

enum ApiPermission {
  FULL
  SENDING
}

model ApiKey {
  id           Int           @id @default(autoincrement())
  clientId     String        @unique
  tokenHash    String
  partialToken String
  name         String
  permission   ApiPermission @default(SENDING)
  domainId     Int?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  lastUsed     DateTime?
  teamId       Int
  team         Team          @relation(fields: [teamId], references: [id], onDelete: Cascade)
  domain       Domain?       @relation(fields: [domainId], references: [id], onDelete: SetNull, onUpdate: Cascade)
}

enum EmailStatus {
  SCHEDULED
  QUEUED
  SENT
  DELIVERY_DELAYED
  BOUNCED
  REJECTED
  RENDERING_FAILURE
  DELIVERED
  OPENED
  CLICKED
  COMPLAINED
  FAILED
  CANCELLED
  SUPPRESSED
}

model Email {
  id           String       @id @default(cuid())
  sesEmailId   String?      @unique
  from         String
  to           String[]
  replyTo      String[]
  cc           String[]
  bcc          String[]
  subject      String
  text         String?
  html         String?
  latestStatus EmailStatus  @default(QUEUED)
  teamId       Int
  domainId     Int?
  apiId        Int?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  scheduledAt  DateTime?
  attachments  String?
  campaignId   String?
  contactId    String?
  inReplyToId  String?
  headers      String?
  team             Team         @relation(fields: [teamId], references: [id], onDelete: Cascade)
  emailEvents      EmailEvent[]
  engagementEvents EmailEngagementEvent[]

  @@index([campaignId, contactId])
  @@index([createdAt(sort: Desc)])
}

model CampaignEmail {
  campaignId String
  contactId  String
  emailId    String
  createdAt  DateTime @default(now())

  @@id([campaignId, contactId])
}

model EmailEvent {
  id        String      @id @default(cuid())
  emailId   String
  status    EmailStatus
  data      Json?
  teamId    Int?
  createdAt DateTime    @default(now())
  email     Email       @relation(fields: [emailId], references: [id], onDelete: Cascade)

  @@index([emailId])
  @@index([teamId])
}

model ContactBook {
  id         String    @id @default(cuid())
  name       String
  teamId     Int
  properties Json
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  emoji      String    @default("ðŸ“™")
  team       Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  contacts   Contact[]
  segments   Segment[]
  sequences  AutomationSequence[]

  @@index([teamId])
}

enum UnsubscribeReason {
  BOUNCED
  COMPLAINED
  UNSUBSCRIBED
}

enum SuppressionReason {
  HARD_BOUNCE
  COMPLAINT
  MANUAL
}

model Contact {
  id                String             @id @default(cuid())
  firstName         String?
  lastName          String?
  email             String
  subscribed        Boolean            @default(true)
  unsubscribeReason UnsubscribeReason?
  properties        Json
  contactBookId     String
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  contactBook         ContactBook          @relation(fields: [contactBookId], references: [id], onDelete: Cascade)
  sequenceEnrollments SequenceEnrollment[]
  engagementPattern   ContactEngagementPattern?
  engagementEvents    EmailEngagementEvent[]

  @@unique([contactBookId, email])
  @@index([contactBookId, id])
}

model Segment {
  id            String   @id @default(cuid())
  name          String
  description   String?
  contactBookId String
  filters       Json     // Array of filter conditions
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  contactBook ContactBook @relation(fields: [contactBookId], references: [id], onDelete: Cascade)

  @@index([contactBookId])
}

enum ReportFrequency {
  DAILY
  WEEKLY
  MONTHLY
}

model ScheduledReport {
  id          String          @id @default(cuid())
  name        String
  teamId      Int
  recipients  String[]        // Email addresses to send report to
  frequency   ReportFrequency
  dayOfWeek   Int?            // 0-6 for weekly reports (0 = Sunday)
  dayOfMonth  Int?            // 1-31 for monthly reports
  hour        Int             @default(9) // Hour to send (0-23)
  timezone    String          @default("UTC")
  enabled     Boolean         @default(true)
  lastSentAt  DateTime?
  nextSendAt  DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@index([nextSendAt])
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  RUNNING
  PAUSED
  SENT
}

// A/B Testing
enum ABTestStatus {
  DRAFT
  RUNNING
  COMPLETED
  CANCELLED
}

enum ABTestWinnerCriteria {
  OPEN_RATE
  CLICK_RATE
  MANUAL
}

model ABTest {
  id              String              @id @default(cuid())
  name            String
  teamId          Int
  campaignId      String              @unique
  status          ABTestStatus        @default(DRAFT)
  winnerCriteria  ABTestWinnerCriteria @default(OPEN_RATE)
  testPercentage  Int                 @default(20) // % of contacts for testing
  testDurationHours Int               @default(4)  // Hours before selecting winner
  winnerVariantId String?
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  team     Team           @relation(fields: [teamId], references: [id], onDelete: Cascade)
  campaign Campaign       @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  variants ABTestVariant[]

  @@index([teamId])
  @@index([status])
}

model ABTestVariant {
  id          String   @id @default(cuid())
  abTestId    String
  name        String   // "A", "B", "C", etc.
  subject     String
  previewText String?
  content     String?  // Email editor JSON content
  html        String?
  sent        Int      @default(0)
  delivered   Int      @default(0)
  opened      Int      @default(0)
  clicked     Int      @default(0)
  isWinner    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  abTest ABTest @relation(fields: [abTestId], references: [id], onDelete: Cascade)

  @@index([abTestId])
}

model Campaign {
  id                 String         @id @default(cuid())
  name               String
  teamId             Int
  from               String
  cc                 String[]
  bcc                String[]
  replyTo            String[]
  domainId           Int
  subject            String
  previewText        String?
  html               String?
  content            String?
  contactBookId      String?
  scheduledAt        DateTime?
  total              Int            @default(0)
  sent               Int            @default(0)
  delivered          Int            @default(0)
  opened             Int            @default(0)
  clicked            Int            @default(0)
  unsubscribed       Int            @default(0)
  bounced            Int            @default(0)
  hardBounced        Int            @default(0)
  complained         Int            @default(0)
  isApi              Boolean        @default(false)
  status             CampaignStatus @default(DRAFT)
  batchSize          Int            @default(500)
  batchWindowMinutes Int            @default(0)
  lastCursor         String?
  lastSentAt         DateTime?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt

  team   Team    @relation(fields: [teamId], references: [id], onDelete: Cascade)
  abTest ABTest?

  @@index([createdAt(sort: Desc)])
  @@index([status, scheduledAt])
}

model Template {
  id        String   @id @default(cuid())
  name      String
  teamId    Int
  subject   String
  html      String?
  content   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  team          Team           @relation(fields: [teamId], references: [id], onDelete: Cascade)
  sequenceSteps SequenceStep[]

  @@index([createdAt(sort: Desc)])
}

enum EmailUsageType {
  TRANSACTIONAL
  MARKETING
}

model DailyEmailUsage {
  teamId      Int
  date        String
  type        EmailUsageType
  domainId    Int
  sent        Int            @default(0)
  delivered   Int            @default(0)
  opened      Int            @default(0)
  clicked     Int            @default(0)
  bounced     Int            @default(0)
  complained  Int            @default(0)
  hardBounced Int            @default(0)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@id([teamId, domainId, date, type])
}

model CumulatedMetrics {
  teamId      Int
  domainId    Int
  delivered   BigInt @default(0)
  hardBounced BigInt @default(0)
  complained  BigInt @default(0)

  @@id([teamId, domainId])
}

model SuppressionList {
  id        String            @id @default(cuid())
  email     String // The suppressed email address
  teamId    Int // Team that owns this suppression
  reason    SuppressionReason // Why it was suppressed
  source    String? // Source email ID that triggered suppression
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, email])
}

// Webhook event types that can trigger notifications
enum WebhookEventType {
  SENT
  DELIVERED
  BOUNCED
  COMPLAINED
  OPENED
  CLICKED
  FAILED
}

model Webhook {
  id          String             @id @default(cuid())
  name        String
  url         String
  secret      String // Used to sign webhook payloads
  events      WebhookEventType[] // Events to subscribe to
  enabled     Boolean            @default(true)
  teamId      Int
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  team       Team              @relation(fields: [teamId], references: [id], onDelete: Cascade)
  deliveries WebhookDelivery[]

  @@index([teamId])
}

enum WebhookDeliveryStatus {
  PENDING
  SUCCESS
  FAILED
}

model WebhookDelivery {
  id           String                @id @default(cuid())
  webhookId    String
  emailId      String?
  eventType    WebhookEventType
  payload      Json
  status       WebhookDeliveryStatus @default(PENDING)
  statusCode   Int?
  response     String?
  attempts     Int                   @default(0)
  lastAttempt  DateTime?
  createdAt    DateTime              @default(now())

  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([createdAt(sort: Desc)])
}

// Audit Logging
enum AuditAction {
  CREATE
  UPDATE
  DELETE
  SEND
  PAUSE
  RESUME
  SCHEDULE
  LOGIN
  INVITE
  EXPORT
}

enum AuditResourceType {
  CAMPAIGN
  CONTACT
  CONTACT_BOOK
  DOMAIN
  API_KEY
  TEMPLATE
  WEBHOOK
  TEAM_MEMBER
  SCHEDULED_REPORT
  SEGMENT
  EMAIL
  SUPPRESSION
}

model AuditLog {
  id           String            @id @default(cuid())
  teamId       Int
  userId       Int?
  action       AuditAction
  resourceType AuditResourceType
  resourceId   String?
  resourceName String?
  details      Json?             // Additional context (before/after values, etc.)
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime          @default(now())

  team Team  @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([teamId])
  @@index([userId])
  @@index([resourceType, resourceId])
  @@index([createdAt(sort: Desc)])
}

// Email Automation Sequences
enum SequenceStatus {
  DRAFT
  ACTIVE
  PAUSED
  ARCHIVED
}

enum SequenceStepType {
  EMAIL           // Send an email
  DELAY           // Wait for a specified duration
  CONDITION       // Branch based on conditions (opened, clicked, etc.)
  GOAL            // End sequence when goal is reached
}

enum SequenceTriggerType {
  CONTACT_CREATED       // When a contact is added to a contact book
  TAG_ADDED             // When a tag is added to a contact
  FORM_SUBMITTED        // When a form is submitted
  CAMPAIGN_CLICKED      // When a campaign link is clicked
  CAMPAIGN_OPENED       // When a campaign is opened
  MANUAL                // Manually enrolled
}

enum EnrollmentStatus {
  ACTIVE       // Currently progressing through sequence
  COMPLETED    // Finished all steps
  PAUSED       // Temporarily paused
  EXITED       // Left sequence early (unsubscribed, goal reached, etc.)
}

model AutomationSequence {
  id                String                @id @default(cuid())
  name              String
  description       String?
  teamId            Int
  contactBookId     String?               // Target contact book
  status            SequenceStatus        @default(DRAFT)
  triggerType       SequenceTriggerType   @default(MANUAL)
  triggerConfig     Json?                 // Configuration for the trigger (e.g., which tag, which form)
  fromEmail         String?               // Sender email for sequence emails
  fromName          String?               // Sender name
  replyTo           String?
  exitOnUnsubscribe Boolean               @default(true)
  exitOnGoal        Boolean               @default(true)
  allowReentry      Boolean               @default(false)
  totalEnrolled     Int                   @default(0)
  totalCompleted    Int                   @default(0)
  totalExited       Int                   @default(0)
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt

  team        Team                  @relation(fields: [teamId], references: [id], onDelete: Cascade)
  contactBook ContactBook?          @relation(fields: [contactBookId], references: [id], onDelete: SetNull)
  steps       SequenceStep[]
  enrollments SequenceEnrollment[]

  @@index([teamId])
  @@index([status])
  @@index([contactBookId])
}

model SequenceStep {
  id              String           @id @default(cuid())
  sequenceId      String
  order           Int              // Position in the sequence
  type            SequenceStepType
  name            String?          // Optional step name for display

  // For EMAIL type
  subject         String?
  previewText     String?
  html            String?          @db.Text
  templateId      String?          // Can use an existing template

  // For DELAY type
  delayDuration   Int?             // Duration in minutes
  delayUnit       String?          // "minutes", "hours", "days"

  // For CONDITION type
  conditionType   String?          // "opened", "clicked", "not_opened", "not_clicked"
  conditionValue  String?          // e.g., specific link URL for click condition
  yesStepId       String?          // Step to go to if condition is true
  noStepId        String?          // Step to go to if condition is false

  // For GOAL type
  goalType        String?          // "clicked", "replied", "purchased"
  goalValue       String?

  // Metrics
  sent            Int              @default(0)
  delivered       Int              @default(0)
  opened          Int              @default(0)
  clicked         Int              @default(0)

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  sequence   AutomationSequence     @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  template   Template?              @relation(fields: [templateId], references: [id], onDelete: SetNull)
  enrollments SequenceEnrollment[]  @relation("CurrentStep")

  @@index([sequenceId])
  @@index([order])
}

model SequenceEnrollment {
  id              String           @id @default(cuid())
  sequenceId      String
  contactId       String
  currentStepId   String?          // Current step in the sequence
  status          EnrollmentStatus @default(ACTIVE)
  currentStepOrder Int             @default(0)

  // Timing
  enrolledAt      DateTime         @default(now())
  nextStepAt      DateTime?        // When the next step should execute
  completedAt     DateTime?
  exitedAt        DateTime?
  exitReason      String?          // Why they exited (unsubscribed, goal_reached, manual, etc.)

  // Metrics for this contact's journey
  emailsSent      Int              @default(0)
  emailsOpened    Int              @default(0)
  emailsClicked   Int              @default(0)

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  sequence    AutomationSequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  contact     Contact            @relation(fields: [contactId], references: [id], onDelete: Cascade)
  currentStep SequenceStep?      @relation("CurrentStep", fields: [currentStepId], references: [id], onDelete: SetNull)

  @@unique([sequenceId, contactId])
  @@index([sequenceId])
  @@index([contactId])
  @@index([status])
  @@index([nextStepAt])
}

// Send-Time Optimization
model ContactEngagementPattern {
  id            String   @id @default(cuid())
  contactId     String   @unique
  teamId        Int

  // Hourly engagement scores (0-23 hours in UTC)
  // Each value is a score 0-100 representing engagement likelihood
  hourlyScores  Json     // { "0": 10, "1": 5, ..., "23": 30 }

  // Day of week scores (0=Sunday, 6=Saturday)
  dayOfWeekScores Json   // { "0": 20, "1": 80, ..., "6": 15 }

  // Best time windows
  bestHourUtc   Int?     // Best hour to send (0-23)
  bestDayOfWeek Int?     // Best day to send (0-6)

  // Engagement history stats
  totalOpens    Int      @default(0)
  totalClicks   Int      @default(0)
  totalEmails   Int      @default(0)

  // Timezone inference
  inferredTimezone String?

  lastCalculatedAt DateTime @default(now())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  contact Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  team    Team    @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@index([bestHourUtc])
}

model TeamSendTimeSettings {
  id              String   @id @default(cuid())
  teamId          Int      @unique

  // Global send time optimization settings
  enableOptimization Boolean @default(false)

  // Default send window (if no contact data available)
  defaultHourStart Int     @default(9)  // 9 AM
  defaultHourEnd   Int     @default(17) // 5 PM

  // Days to exclude from sending
  excludeDays     Json     @default("[]") // e.g., [0, 6] for weekends

  // Timezone for defaults
  defaultTimezone String   @default("UTC")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
}

// Track individual email engagement events for learning
model EmailEngagementEvent {
  id        String   @id @default(cuid())
  emailId   String
  contactId String
  teamId    Int
  eventType String   // "open", "click"
  eventHour Int      // Hour when event occurred (0-23)
  eventDay  Int      // Day of week (0-6)
  eventAt   DateTime
  createdAt DateTime @default(now())

  email   Email   @relation(fields: [emailId], references: [id], onDelete: Cascade)
  contact Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  team    Team    @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([contactId])
  @@index([teamId])
  @@index([eventAt])
}
